<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baza Danych Pojazdów - MDT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style> 
        body { font-family: 'Inter', sans-serif; }
        .sortable:hover { cursor: pointer; background-color: #374151; }
        .modal-backdrop { display: none; }
        .modal-backdrop.flex { display: flex; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex h-screen">

    <aside id="sidebar-container" class="w-64 bg-gray-800 p-4 flex flex-col min-h-screen flex-shrink-0"></aside>

    <main class="flex-1 p-8 overflow-y-auto">
        <h1 class="text-3xl font-bold text-white mb-6">Baza Danych Pojazdów</h1>
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-6">
            <div class="flex items-center space-x-4">
                <input type="text" id="search-input" class="flex-grow bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Filtruj po numerze rejestracyjnym lub właścicielu...">
            </div>
        </div>

        <div id="table-container" class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
             <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-left text-gray-300">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                        <tr>
                            <th class="px-6 py-3">Rejestracja</th>
                            <th class="px-6 py-3">Właściciel</th>
                            <th class="px-6 py-3">Status</th>
                            <th id="sort-date" class="px-6 py-3 sortable">Data Ostatniego Badania <i data-lucide="arrow-down-up" class="inline w-3 h-3 ml-1"></i></th>
                        </tr>
                    </thead>
                    <tbody id="vehicles-table-body">
                    </tbody>
                </table>
            </div>
        </div>
        <div id="message-container" class="text-center py-10"></div>
    </main>

    <div id="vehicle-details-modal" class="modal-backdrop fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 z-50 justify-center items-center p-4">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-4xl p-6 relative max-h-[90vh] flex flex-col">
            <h3 id="modal-plate" class="text-2xl font-bold text-white mb-4"></h3>
            <div id="modal-content" class="flex-grow overflow-y-auto space-y-4 text-sm pr-4">
                </div>
            <button id="modal-close-button" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
        </div>
    </div>
    
    <script src="shared.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSidebarAndUserData('vehicle-database');
            const token = localStorage.getItem('mdt-token');
            const searchInput = document.getElementById('search-input');
            const tableBody = document.getElementById('vehicles-table-body');
            const messageContainer = document.getElementById('message-container');
            const sortDateButton = document.getElementById('sort-date');
            
            const modal = document.getElementById('vehicle-details-modal');
            const modalPlate = document.getElementById('modal-plate');
            const modalContent = document.getElementById('modal-content');
            const modalCloseButton = document.getElementById('modal-close-button');

            let allVehicles = [];
            let dateSortDirection = 'desc'; 

            async function loadAndRenderVehicles() {
                messageContainer.innerHTML = '<p class="text-gray-500">Ładowanie danych...</p>';
                tableBody.innerHTML = '';
                try {
                    const response = await fetch('/api/vehicles', { headers: { 'Authorization': token } });
                    if (!response.ok) throw new Error('Błąd odpowiedzi serwera');
                    allVehicles = await response.json();
                    renderTable();
                } catch (error) {
                    messageContainer.innerHTML = '<p class="text-red-500">Nie udało się załadować bazy pojazdów.</p>';
                }
            }
            
            function renderTable() {
                allVehicles.sort((a, b) => {
                    const dateA = new Date(a.lastInspection);
                    const dateB = new Date(b.lastInspection);
                    return dateSortDirection === 'asc' ? dateA - dateB : dateB - dateA;
                });
                
                const filterText = searchInput.value.toLowerCase();
                const filteredVehicles = allVehicles.filter(v => 
                    v.plate.toLowerCase().includes(filterText) ||
                    (v.ownerName && v.ownerName.toLowerCase().includes(filterText))
                );

                tableBody.innerHTML = ''; 
                if (filteredVehicles.length === 0) {
                    messageContainer.innerHTML = '<p class="text-gray-500">Brak pojazdów w bazie danych.</p>';
                } else {
                    messageContainer.innerHTML = '';
                }

                filteredVehicles.forEach(vehicle => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-700 cursor-pointer';
                    row.dataset.plate = vehicle.plate;
                    
                    let statusClass = 'text-gray-400';
                    if(vehicle.status.includes('POZYTYWNY')) statusClass = 'text-green-400';
                    if(vehicle.status.includes('NEGATYWNY')) statusClass = 'text-red-400';
                    if(vehicle.status.includes('DEMONTAŻ')) statusClass = 'text-yellow-400';

                    row.innerHTML = `
                        <td class="px-6 py-4 font-mono text-blue-400">${vehicle.plate}</td>
                        <td class="px-6 py-4">${vehicle.ownerName}</td>
                        <td class="px-6 py-4 font-bold ${statusClass}">${vehicle.status}</td>
                        <td class="px-6 py-4">${new Date(vehicle.lastInspection).toLocaleString('pl-PL')}</td>
                    `;
                    tableBody.appendChild(row);
                });
                lucide.createIcons();
            }

            async function showVehicleDetails(plate) {
                const response = await fetch(`/api/vehicle/${plate}`, { headers: { 'Authorization': token }});
                const data = await response.json();
                
                modalPlate.textContent = `Szczegóły pojazdu: ${data.plate}`;
                
                let historyHtml = '<h3>Historia Badań Technicznych</h3>';
                data.inspections.forEach(insp => {
                    historyHtml += `
                        <div class="mt-4 bg-gray-900 p-3 rounded-lg">
                            <p class="text-sm font-semibold text-gray-400">${new Date(insp.date).toLocaleString('pl-PL')}</p>
                            <pre class="whitespace-pre-wrap font-mono text-xs mt-2">${insp.content}</pre>
                        </div>
                    `;
                });

                modalContent.innerHTML = historyHtml;
                modal.classList.add('flex');
            }

            searchInput.addEventListener('input', renderTable);
            sortDateButton.addEventListener('click', () => {
                dateSortDirection = dateSortDirection === 'asc' ? 'desc' : 'asc';
                renderTable();
            });
            
            tableBody.addEventListener('click', (e) => {
                const row = e.target.closest('tr');
                if (row && row.dataset.plate) {
                    showVehicleDetails(row.dataset.plate);
                }
            });
            
            modalCloseButton.addEventListener('click', () => modal.classList.remove('flex'));

            loadAndRenderVehicles();
        });
    </script>
</body>
</html>